<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Created by Ali Muridke (03091539086) - Education Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #5e35b1;
            --primary-dark: #4527a0;
            --secondary: #00bcd4;
            --success: #66bb6a;
            --danger: #ef5350;
            --warning: #ffb300;
            --background: #121212;
            --surface: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border: #333333;
            --sidebar-width: 280px;
            --header-height: 70px;
            --shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            --radius: 8px;
            --transition: all 0.3s ease-in-out;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .shadow-md {
            box-shadow: var(--shadow);
        }

        /* Auth Section */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-dark) 0%, #1a1a2e 100%);
            padding: 20px;
        }

        .auth-form {
            background: var(--surface);
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            width: 100%;
            max-width: 450px;
            border-top: 5px solid var(--primary);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            color: var(--primary);
            font-size: 32px;
            margin-bottom: 10px;
        }

        .auth-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 4px;
            overflow: hidden;
            background: var(--border);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .auth-tab.active {
            background: var(--primary);
            color: var(--text-primary);
            box-shadow: inset 0 -3px 0 var(--secondary);
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 16px;
            transition: var(--transition);
            background: #2b2b2b;
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-dark);
        }

        .btn {
            display: inline-block;
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            text-align: center;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .btn:hover {
            background: var(--primary-dark);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #5cb860;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-danger:hover {
            background: #e53935;
        }

        .btn-warning {
            background: var(--warning);
        }

        .btn-warning:hover {
            background: #fbc02d;
        }

        .btn-whatsapp {
            background: #25D366;
        }

        .btn-whatsapp:hover {
            background: #128C7E;
        }

        /* Main App */
        #appSection {
            display: none;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            color: var(--text-primary);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 1000;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
        }
        
        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            color: var(--secondary);
        }
        
        .logo-title {
            display: flex;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 20px;
            margin-left: 10px;
            font-weight: 400;
        }
        
        .sidebar-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }
        
        .sidebar-close-btn:hover {
            color: var(--primary);
        }

        .sidebar-menu {
            list-style: none;
            padding: 10px 0;
        }

        .sidebar-menu li {
            padding: 14px 25px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            font-weight: 400;
            color: var(--text-secondary);
        }

        .sidebar-menu li i {
            margin-right: 15px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .sidebar-menu li:hover {
            background: #2c2c2c;
            color: var(--text-primary);
        }

        .sidebar-menu li.active {
            background: var(--primary-dark);
            color: var(--text-primary);
            border-left: 4px solid var(--secondary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 25px;
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }
        
        .sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            transition: opacity 0.3s;
        }
        
        .sidebar-backdrop.open {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 25px;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            position: sticky; 
            top: 0;
            z-index: 900;
        }
        
        .header-left-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .menu-toggle {
            font-size: 24px;
            cursor: pointer;
            background: var(--primary);
            color: var(--text-primary);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--primary-dark);
        }
        
        .three-dot-menu {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-primary);
            padding: 5px;
            transition: color 0.3s;
            display: none;
        }
        
        #pageTitle {
            font-size: 16px;
            color: var(--secondary);
            font-weight: 500;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            color: var(--surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .user-info div:last-child {
            color: var(--text-secondary);
            display: flex;
            flex-direction: column; 
            gap: 5px;
        }
        
        /* Logout button specific styling on small screens */
        @media (max-width: 991px) {
            .user-info div:last-child > div {
                display: none;
            }
            #logoutBtn {
                margin: 0;
                padding: 5px 10px;
            }
            .user-info div:last-child {
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
        }
        
        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 25px;
        }

        .section-header h2 {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .section-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 5px solid var(--primary);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.6);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(94, 53, 177, 0.3);
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 15px;
        }

        .card h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 400;
        }

        .card-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .card-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Forms */
        .form-container {
            background: var(--surface);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .form-container h3 {
             color: var(--secondary);
             margin-bottom: 20px;
             border-bottom: 1px solid var(--border);
             padding-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Tables */
        .table-container {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .table-container h3 {
             padding: 15px 20px;
             color: var(--text-primary);
             font-weight: 500;
             background-color: #2b2b2b;
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #2b2b2b;
            padding: 14px 20px;
            text-align: left;
            font-weight: 500;
            color: var(--secondary);
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: rgba(94, 53, 177, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 3px;
            text-transform: none;
        }

        /* Calculator */
        .calculator {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            max-width: 350px;
            margin: 0 auto;
        }

        .calc-display {
            width: 100%;
            padding: 20px;
            font-size: 32px;
            text-align: right;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: #2b2b2b;
            color: var(--text-primary);
            font-weight: 400;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calc-btn {
            padding: 18px;
            font-size: 18px;
            border: none;
            background: #2b2b2b;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 4px;
            transition: var(--transition);
            font-weight: 500;
        }

        .calc-btn:hover {
            background: #3a3a3a;
        }

        .calc-btn.operator {
            background: var(--primary);
            color: white;
        }

        .calc-btn.operator:hover {
            background: var(--primary-dark);
        }

        .calc-btn.equals {
            background: var(--success);
            color: white;
            grid-row: span 2;
        }

        .calc-btn.equals:hover {
            background: #5cb860;
        }

        .calc-btn.clear {
            background: var(--danger);
            color: white;
        }

        .calc-btn.clear:hover {
            background: #e53935;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: var(--surface);
            padding: 30px;
            border-radius: var(--radius);
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: modalFade 0.3s ease;
            border-top: 5px solid var(--secondary);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: var(--secondary);
            font-size: 22px;
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        /* Status Indicators */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-present {
            background: rgba(102, 187, 106, 0.2);
            color: var(--success);
        }

        .status-absent {
            background: rgba(239, 83, 80, 0.2);
            color: var(--danger);
        }

        .status-pending {
            background: rgba(255, 179, 0, 0.2);
            color: var(--warning);
        }

        /* Fee Status */
        .fee-status {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .fee-paid {
            background: rgba(102, 187, 106, 0.2);
            color: var(--success);
        }
        
        .fee-partial {
            background: rgba(255, 179, 0, 0.2);
            color: var(--warning);
        }
        
        .fee-pending {
            background: rgba(239, 83, 80, 0.2);
            color: var(--danger);
        }
        
        /* Currency Styling */
        .currency {
            font-weight: 700;
            color: var(--success);
        }

        .currency::before {
            content: "PKR ";
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        /* WhatsApp Notification */
        .whatsapp-notification {
            background: #25D366;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .whatsapp-notification:hover {
            background: #128C7E;
        }
        
        /* Disclaimer Styling */
        .disclaimer-box {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid var(--warning);
            border-radius: var(--radius);
            background-color: rgba(255, 179, 0, 0.1);
            color: var(--warning);
            font-size: 14px;
        }
        
        .disclaimer-box p {
            margin-bottom: 5px;
        }
        
        .disclaimer-box strong {
            color: var(--primary);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes modalFade {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Responsive Fixes */
        @media (min-width: 992px) {
            .sidebar {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: var(--sidebar-width);
            }
            
            .sidebar-close-btn {
                display: none;
            }
            
            .three-dot-menu {
                display: block;
                color: var(--primary);
            }
            
            .menu-toggle {
                display: none;
            }
            
            .header {
                 justify-content: flex-start;
                 gap: 25px;
            }
            
             .user-info {
                margin-left: auto;
            }
            
            #pageTitle {
                text-align: left;
                flex-grow: 0;
            }
        }
        
        @media (max-width: 991px) {
            .sidebar {
                width: 80vw;
                max-width: var(--sidebar-width);
                z-index: 1001;
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
                padding: 10px 15px;
            }
            
            .header-left-group {
                order: 1;
            }
            
            #pageTitle {
                order: 2;
                flex-grow: 1;
                text-align: center;
                display: block;
                font-size: 16px;
            }
            
            .user-info {
                order: 3;
                gap: 5px;
            }
            
            .menu-toggle {
                align-self: center;
                margin-bottom: 0;
            }
            
            .three-dot-menu {
                display: block;
                order: 4;
                color: var(--primary);
            }
            
            .user-info div:last-child > div:first-child {
                display: none;
            }
            
            .user-info div:last-child {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }

            /* Responsive Table CSS */
            .table-container table,
            .table-container thead,
            .table-container tbody,
            .table-container th,
            .table-container td,
            .table-container tr {
                display: block;
            }

            .table-container thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .table-container tr {
                border: 1px solid var(--border);
                margin-bottom: 10px;
                border-radius: var(--radius);
                overflow: hidden;
            }

            .table-container td {
                border: none;
                border-bottom: 1px solid var(--border);
                position: relative;
                padding-left: 50%;
                text-align: right;
            }
            
            .table-container td:last-child {
                border-bottom: none;
            }

            #studentsSection .table-container td:nth-of-type(1):before { content: "ID"; }
            #studentsSection .table-container td:nth-of-type(2):before { content: "Name"; }
            #studentsSection .table-container td:nth-of-type(3):before { content: "Grade"; }
            #studentsSection .table-container td:nth-of-type(4):before { content: "Phone"; }
            #studentsSection .table-container td:nth-of-type(5):before { content: "Monthly Fee"; }
            #studentsSection .table-container td:nth-of-type(6):before { content: "Fee Status"; }
            #studentsSection .table-container td:nth-of-type(7):before { content: "Actions"; }
            
            #feesSection .table-container td:nth-of-type(1):before { content: "Receipt ID"; }
            #feesSection .table-container td:nth-of-type(2):before { content: "Student Name"; }
            #feesSection .table-container td:nth-of-type(3):before { content: "Month"; }
            #feesSection .table-container td:nth-of-type(4):before { content: "Amount"; }
            #feesSection .table-container td:nth-of-type(5):before { content: "Status"; }
            #feesSection .table-container td:nth-of-type(6):before { content: "Date Paid"; }
            #feesSection .table-container td:nth-of-type(7):before { content: "Actions"; }

            .table-container td:before {
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 500;
                color: var(--secondary);
                text-transform: uppercase;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="authSection" class="auth-container">
        <div class="auth-form shadow-md">
            <div class="auth-header">
                <h1><i class="fas fa-graduation-cap"></i> Ali Muridke CMS</h1>
                <p>Education Management System Login</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab">Login</div>
                <div class="auth-tab" id="registerTab">Register</div>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn">Login to Dashboard</button>
            </form>
            
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerUsername"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="registerUsername" class="form-control" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="registerPIN"><i class="fas fa-key"></i> Security PIN</label>
                    <input type="password" id="registerPIN" class="form-control" placeholder="4-digit PIN for security" maxlength="4" required>
                </div>
                <button type="submit" class="btn btn-success">Create Account</button>
            </form>
            
            <div id="authMessage" style="margin-top: 20px;"></div>

            <div class="disclaimer-box">
                <p><strong>⚠️ Data Storage Disclaimer:</strong></p>
                <p><strong>English:</strong> This application uses your browser's **Local Storage** to save all data (users, students, fees, attendance). The developer is not responsible if the app's data is lost due to browser cache clearing, application deletion, or any system failure.</p>
                <p><strong>اردو:</strong> یہ ایپلیکیشن تمام ڈیٹا (صارفین، طلباء، فیس، حاضری) کو آپ کے براؤزر کی **لوکل سٹوریج** میں محفوظ کرتی ہے۔ اگر براؤزر کا کیش کلیئر ہونے، ایپلیکیشن ڈیلیٹ ہونے، یا کسی بھی سسٹم کی خرابی کی وجہ سے ڈیٹا ضائع ہو جاتا ہے تو ڈویلپر ذمہ دار نہیں ہوگا۔</p>
            </div>
        </div>
    </div>

    <div id="appSection" class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-title">
                    <i class="fas fa-graduation-cap fa-2x"></i>
                    <h2>EMS Dashboard</h2>
                </div>
                <button class="sidebar-close-btn" id="sidebarCloseBtn" aria-label="Close menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li class="active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </li>
                <li data-section="students">
                    <i class="fas fa-user-graduate"></i> Student Admission
                </li>
                <li data-section="fees">
                    <i class="fas fa-money-bill-wave"></i> Fee Collection
                </li>
                <li data-section="attendance">
                    <i class="fas fa-calendar-check"></i> Attendance
                </li>
                <li data-section="calculator">
                    <i class="fas fa-calculator"></i> Calculator
                </li>
            </ul>
        </div>
        
        <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

        <div class="main-content" id="mainContent">
            <div class="header shadow-md">
                <div class="header-left-group">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <i class="fas fa-ellipsis-v three-dot-menu" onclick="alert('Options Menu Coming Soon!')"></i>
                </div>

                <h1 id="pageTitle">Dashboard Overview</h1>

                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div>Welcome, <strong id="loggedInUser">User</strong></div>
                        <button id="logoutBtn" class="btn btn-danger btn-sm">Logout</button>
                    </div>
                </div>
            </div>

            <div id="dashboardSection" class="content-section active">
                <div class="section-header">
                    <h2>Dashboard Overview</h2>
                    <p>Welcome to your education management dashboard</p>
                </div>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Total Students</h3>
                        <div class="card-value" id="totalStudents">0</div>
                        <div class="card-desc">Registered in academy</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <h3>Fees Collected</h3>
                        <div class="card-value"><span class="currency" id="feesCollected">0</span></div>
                        <div class="card-desc">This month</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <h3>Today's Attendance</h3>
                        <div class="card-value" id="todayAttendance">0%</div>
                        <div class="card-desc">Present students</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <h3>Pending Fees</h3>
                        <div class="card-value" id="pendingFees">0</div>
                        <div class="card-desc">For current month</div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="table-container shadow-md">
                        <h3>Recent Fee Collections</h3>
                        <div class="table-responsive">
                            <table id="recentFeesTable">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-container shadow-md">
                        <h3>Recent Attendance</h3>
                         <div class="table-responsive">
                            <table id="recentAttendanceTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Present</th>
                                        <th>Absent</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="studentsSection" class="content-section">
                <div class="section-header">
                    <h2>Student Admission</h2>
                    <p>Manage student records and information</p>
                </div>
                
                <div class="form-container shadow-md">
                    <h3>Add New Student</h3>
                    <form id="studentForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="studentName">Student Name</label>
                                <input type="text" id="studentName" class="form-control" placeholder="Full name of student" required>
                            </div>
                            <div class="form-group">
                                <label for="studentGrade">Grade (1-12)</label>
                                <select id="studentGrade" class="form-control" required>
                                    <option value="">Select Grade</option>
                                    <option value="1">Grade 1</option>
                                    <option value="2">Grade 2</option>
                                    <option value="3">Grade 3</option>
                                    <option value="4">Grade 4</option>
                                    <option value="5">Grade 5</option>
                                    <option value="6">Grade 6</option>
                                    <option value="7">Grade 7</option>
                                    <option value="8">Grade 8</option>
                                    <option value="9">Grade 9</option>
                                    <option value="10">Grade 10</option>
                                    <option value="11">Grade 11</option>
                                    <option value="12">Grade 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="studentPhone">Parent's Phone</label>
                                <input type="tel" id="studentPhone" class="form-control" placeholder="03XX-XXXXXXX" required>
                            </div>
                            <div class="form-group">
                                <label for="studentFee">Monthly Fee (PKR)</label>
                                <input type="number" id="studentFee" class="form-control" placeholder="Monthly fee amount" required>
                            </div>
                        </div>
                        <button type="submit" class="btn" style="margin-top: 20px;"><i class="fas fa-plus-circle"></i> Add Student</button>
                    </form>
                </div>
                
                <div class="table-container shadow-md">
                    <h3>Student Records (History)</h3>
                    <div class="table-responsive">
                        <table id="studentsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Grade</th>
                                    <th>Phone</th>
                                    <th>Monthly Fee</th>
                                    <th>Fee Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="feesSection" class="content-section">
                <div class="section-header">
                    <h2>Fee Collection</h2>
                    <p>Record and manage student fee payments</p>
                </div>
                
                <div class="form-container shadow-md">
                    <h3>Collect Fee</h3>
                    <form id="feeForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="feeStudent">Select Student</label>
                                <select id="feeStudent" class="form-control" required>
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="feeMonth">Month</label>
                                <input type="month" id="feeMonth" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="feeAmount">Amount (PKR)</label>
                                <input type="number" id="feeAmount" class="form-control" placeholder="Amount to collect" required>
                                <small id="feeHelp" style="color: var(--text-secondary); font-weight: 500; margin-top: 5px; display: block;">
                                    Monthly Fee: <span class="currency" id="monthlyFeeDisplay" style="color: var(--success);">0</span> | 
                                    <span style="color: var(--danger);">Remaining/Due: <span class="currency" id="remainingFeeDisplay" style="color: var(--danger);">0</span></span>
                                </small>
                            </div>
                            <div class="form-group">
                                <label for="feeDate">Payment Date</label>
                                <input type="date" id="feeDate" class="form-control" required>
                            </div>
                        </div>
                        <button type="submit" class="btn" style="margin-top: 20px;"><i class="fas fa-money-check"></i> Collect Fee</button>
                    </form>
                </div>
                
                <div class="table-container shadow-md">
                    <h3>Fee Records (History)</h3>
                    <div class="table-responsive">
                        <table id="feesTable">
                            <thead>
                                <tr>
                                    <th>Receipt ID</th>
                                    <th>Student Name</th>
                                    <th>Month</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date Paid</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="attendanceSection" class="content-section">
                <div class="section-header">
                    <h2>Attendance Management</h2>
                    <p>Track and manage student attendance</p>
                </div>
                
                <div class="form-container shadow-md">
                    <h3>Mark Attendance</h3>
                    <form id="attendanceForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="attendanceDate">Date</label>
                                <input type="date" id="attendanceDate" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Mark Attendance for Students</label>
                            <div id="attendanceList" style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border); padding: 15px; border-radius: 8px; background-color: #2b2b2b;">
                                </div>
                        </div>
                        <button type="submit" class="btn" style="margin-top: 20px;"><i class="fas fa-save"></i> Save Attendance</button>
                    </form>
                </div>
                
                <div class="table-container shadow-md">
                    <h3>Attendance Records (History)</h3>
                    <div class="table-responsive">
                        <table id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Percentage</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="calculatorSection" class="content-section">
                <div class="section-header">
                    <h2>Calculator</h2>
                    <p>Quick calculations for your academy</p>
                </div>
                
                <div class="calculator shadow-md">
                    <input type="text" class="calc-display" id="calcDisplay" readonly>
                    <div class="calc-buttons">
                        <button class="calc-btn clear" onclick="clearCalc()">C</button>
                        <button class="calc-btn" onclick="deleteLast()">⌫</button>
                        <button class="calc-btn operator" onclick="appendToCalc('/')">/</button>
                        <button class="calc-btn operator" onclick="appendToCalc('*')">×</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('7')">7</button>
                        <button class="calc-btn" onclick="appendToCalc('8')">8</button>
                        <button class="calc-btn" onclick="appendToCalc('9')">9</button>
                        <button class="calc-btn operator" onclick="appendToCalc('-')">-</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('4')">4</button>
                        <button class="calc-btn" onclick="appendToCalc('5')">5</button>
                        <button class="calc-btn" onclick="appendToCalc('6')">6</button>
                        <button class="calc-btn operator" onclick="appendToCalc('+')">+</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('1')">1</button>
                        <button class="calc-btn" onclick="appendToCalc('2')">2</button>
                        <button class="calc-btn" onclick="appendToCalc('3')">3</button>
                        <button class="calc-btn equals" onclick="calculateResult()">=</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('0')" style="grid-column: span 2;">0</button>
                        <button class="calc-btn" onclick="appendToCalc('.')">.</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="pinModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-lock"></i> Enter Security PIN</h3>
                <span class="close-modal" onclick="closePinModal()">×</span>
            </div>
            <p style="margin-bottom: 15px; color: var(--text-secondary);">To perform this secure action (Delete/Edit), please enter your 4-digit PIN.</p>
            <div class="form-group">
                <input type="password" id="pinInput" class="form-control" placeholder="Enter your 4-digit PIN" maxlength="4">
            </div>
            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" onclick="closePinModal()">Cancel</button>
                <button class="btn btn-success" onclick="verifyPin()">Verify PIN</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAaM6vNyFpliNAgzujoG4xBDbTGmSB33no",
            authDomain: "ems-by-ali.firebaseapp.com",
            projectId: "ems-by-ali",
            storageBucket: "ems-by-ali.firebasestorage.app",
            messagingSenderId: "920434998465",
            appId: "1:920434998465:web:e52f12fdb9fa1d64cf6840",
            measurementId: "G-ZX7G5E1B45"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Application state
        let currentUser = null;
        let students = [];
        let fees = [];
        let attendance = [];
        let currentAction = null;
        let currentItemId = null;
        let calcExpression = '';

        // Sidebar Elements
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('sidebarBackdrop');

        // Utility function to generate a unique key for the current user's data
        function getUserDataKey(keyName) {
            if (!currentUser || !currentUser.uid) return null;
            return `${keyName}_${currentUser.uid}`;
        }

        // Load user-specific data after login
        function loadUserData() {
            if (!currentUser) return;
            
            const studentKey = getUserDataKey('students');
            const feesKey = getUserDataKey('fees');
            const attendanceKey = getUserDataKey('attendance');
            const userProfileKey = getUserDataKey('profile');
            
            students = JSON.parse(localStorage.getItem(studentKey)) || [];
            fees = JSON.parse(localStorage.getItem(feesKey)) || [];
            attendance = JSON.parse(localStorage.getItem(attendanceKey)) || [];
            
            // Load user profile data if exists
            const userProfile = JSON.parse(localStorage.getItem(userProfileKey));
            if (userProfile) {
                currentUser.username = userProfile.username;
                currentUser.pin = userProfile.pin;
            }
        }

        // Save user-specific data
        function saveUserData() {
            if (!currentUser) return;
            
            const studentKey = getUserDataKey('students');
            const feesKey = getUserDataKey('fees');
            const attendanceKey = getUserDataKey('attendance');
            const userProfileKey = getUserDataKey('profile');
            
            localStorage.setItem(studentKey, JSON.stringify(students));
            localStorage.setItem(feesKey, JSON.stringify(fees));
            localStorage.setItem(attendanceKey, JSON.stringify(attendance));
            
            // Save user profile data
            if (currentUser.username && currentUser.pin) {
                localStorage.setItem(userProfileKey, JSON.stringify({
                    username: currentUser.username,
                    pin: currentUser.pin
                }));
            }
        }

        // Clear user data from memory on logout
        function clearUserData() {
            students = [];
            fees = [];
            attendance = [];
            currentUser = null;
            currentAction = null;
            currentItemId = null;
        }

        // Validate current user session
        function validateUserSession() {
            if (!currentUser) {
                console.error("No user session found");
                handleLogout();
                return false;
            }
            return true;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    currentUser = {
                        uid: user.uid,
                        email: user.email
                    };
                    
                    loadUserData();
                    showApp();
                } else {
                    // User is signed out
                    currentUser = null;
                }
            });

            // Set up event listeners
            setupEventListeners();
            
            // Set current dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('feeMonth').valueAsDate = new Date();
            document.getElementById('feeDate').value = today;
            document.getElementById('attendanceDate').value = today;
            
            // Initial UI update (will use empty data if not logged in)
            updateDashboard();
            updateStudentDropdown();
            loadStudentsTable();
            loadFeesTable();
            loadAttendanceTable();
        });

        // Set up event listeners
        function setupEventListeners() {
            // Auth tabs
            document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
            
            // Auth forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                handleLogout();
            });
            
            // Sidebar toggle and close
            document.getElementById('menuToggle').addEventListener('click', openSidebar); 
            document.getElementById('sidebarCloseBtn').addEventListener('click', closeSidebar);
            backdrop.addEventListener('click', closeSidebar);
            
            // Menu items
            document.querySelectorAll('.sidebar-menu li').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active menu item
                    document.querySelectorAll('.sidebar-menu li').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Close sidebar after selection
                    closeSidebar();
                });
            });
            
            // Student form
            document.getElementById('studentForm').addEventListener('submit', handleAddStudent);
            
            // Fee form
            document.getElementById('feeForm').addEventListener('submit', handleFeeCollection);
            document.getElementById('feeStudent').addEventListener('change', updateFeeInfo);
            document.getElementById('feeMonth').addEventListener('change', updateFeeInfo);
            
            // Attendance form
            document.getElementById('attendanceForm').addEventListener('submit', handleAttendance);
            
            // Listen to date change in attendance section to reload form
            document.getElementById('attendanceDate').addEventListener('change', loadAttendanceForm);
        }

        // Sidebar Control functions
        function openSidebar() {
            sidebar.classList.add('open');
            backdrop.classList.add('open');
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            backdrop.classList.remove('open');
        }

        // Authentication functions
        function switchAuthTab(tab) {
            document.getElementById('loginTab').classList.toggle('active', tab === 'login');
            document.getElementById('registerTab').classList.toggle('active', tab === 'register');
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            document.getElementById('authMessage').innerHTML = '';
            
            if (tab === 'login') {
                document.getElementById('registerForm').reset();
            } else {
                document.getElementById('loginForm').reset();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in 
                    showAuthMessage('Login successful! Redirecting to dashboard...', 'success');
                })
                .catch((error) => {
                    showAuthMessage('Invalid email or password. Please try again.', 'error');
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const pin = document.getElementById('registerPIN').value;
            
            if (pin.length !== 4 || isNaN(pin)) {
                showAuthMessage('PIN must be a 4-digit number', 'error');
                return;
            }
            
            // Check if this username existed in old system
            const oldUsers = JSON.parse(localStorage.getItem('users')) || [];
            const oldUser = oldUsers.find(u => u.username === username);
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed up successfully
                    const user = userCredential.user;
                    
                    // Store user profile data locally
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        username: username,
                        pin: pin
                    };
                    
                    // DATA MIGRATION: If old user exists, migrate their data
                    if (oldUser) {
                        migrateOldUserData(username, user.uid);
                    }
                    
                    saveUserData();
                    
                    if (oldUser) {
                        showAuthMessage('Registration successful! Your old data has been migrated successfully.', 'success');
                    } else {
                        showAuthMessage('Registration successful! You can now login with your credentials.', 'success');
                    }
                    
                    switchAuthTab('login');
                    document.getElementById('registerForm').reset();
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    showAuthMessage('Error creating account: ' + errorMessage, 'error');
                });
        }

        // New function to migrate old user data from localStorage
        function migrateOldUserData(oldUsername, newUid) {
            // Old data keys (from previous username-based system)
            const oldStudentKey = `students_${oldUsername.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}`;
            const oldFeesKey = `fees_${oldUsername.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}`;
            const oldAttendanceKey = `attendance_${oldUsername.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}`;
            
            // New data keys (for Firebase UID-based system)
            const newStudentKey = `students_${newUid}`;
            const newFeesKey = `fees_${newUid}`;
            const newAttendanceKey = `attendance_${newUid}`;
            
            // Migrate students data
            const oldStudents = JSON.parse(localStorage.getItem(oldStudentKey)) || [];
            if (oldStudents.length > 0) {
                localStorage.setItem(newStudentKey, JSON.stringify(oldStudents));
                console.log(`Migrated ${oldStudents.length} students from old account`);
            }
            
            // Migrate fees data
            const oldFees = JSON.parse(localStorage.getItem(oldFeesKey)) || [];
            if (oldFees.length > 0) {
                localStorage.setItem(newFeesKey, JSON.stringify(oldFees));
                console.log(`Migrated ${oldFees.length} fee records from old account`);
            }
            
            // Migrate attendance data
            const oldAttendance = JSON.parse(localStorage.getItem(oldAttendanceKey)) || [];
            if (oldAttendance.length > 0) {
                localStorage.setItem(newAttendanceKey, JSON.stringify(oldAttendance));
                console.log(`Migrated ${oldAttendance.length} attendance records from old account`);
            }
            
            // Remove old user from old users list
            const oldUsers = JSON.parse(localStorage.getItem('users')) || [];
            const updatedUsers = oldUsers.filter(u => u.username !== oldUsername);
            localStorage.setItem('users', JSON.stringify(updatedUsers));
        }

        function showAuthMessage(message, type) {
            const messageDiv = document.getElementById('authMessage');
            const style = type === 'success' ? 'background: #5cb860; color: white; padding: 10px; border-radius: 4px;' : 
                                               'background: #e53935; color: white; padding: 10px; border-radius: 4px;';
            messageDiv.innerHTML = `<div style="${style}">${message}</div>`;
        }

        // Handle logout with proper cleanup
        function handleLogout() {
            // Save any pending data before logout
            if (currentUser) {
                saveUserData();
            }
            
            auth.signOut().then(() => {
                clearUserData();
                
                // Reset forms
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                
                // Show auth section and hide app section
                document.getElementById('authSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
                
                // Switch to login tab
                switchAuthTab('login');
                
                // Clear any auth messages
                document.getElementById('authMessage').innerHTML = '';
                
                console.log("User logged out successfully");
            }).catch((error) => {
                console.error("Error signing out:", error);
            });
        }

        // UI Navigation functions
        function showApp() {
            if (!validateUserSession()) {
                return;
            }
            
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            
            // Handle display for logged-in user
            const userName = currentUser.username || currentUser.email.split('@')[0];
            document.getElementById('loggedInUser').textContent = userName;
            document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
            
            showSection('dashboard');
            
            // Ensure all UI elements are updated with fresh data after login
            updateDashboard();
            updateStudentDropdown();
            loadStudentsTable();
            loadFeesTable();
            loadAttendanceTable();
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            document.getElementById(`${section}Section`).classList.add('active');
            
            const titles = {
                dashboard: 'Dashboard Overview',
                students: 'Student Admission',
                fees: 'Fee Collection',
                attendance: 'Attendance Management',
                calculator: 'Calculator'
            };
            document.getElementById('pageTitle').textContent = titles[section];
            
            if (section === 'attendance') {
                loadAttendanceForm();
            }
        }

        // Student Management functions
        function handleAddStudent(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('studentGrade').value;
            const phone = document.getElementById('studentPhone').value;
            const fee = document.getElementById('studentFee').value;
            
            if (!phone.match(/^03\d{9}$/)) {
                alert('Please enter a valid Pakistani phone number (03XXXXXXXXX)');
                return;
            }
            
            const newStudent = {
                id: generateId(),
                name,
                grade: parseInt(grade),
                phone,
                fee: parseInt(fee),
                admissionDate: new Date().toISOString().split('T')[0],
                createdBy: currentUser.username || currentUser.email
            };
            
            students.push(newStudent);
            saveUserData();
            
            const message = `Assalam-o-Alaikum! ${name} has been admitted to Grade ${grade}. Monthly fee: PKR ${fee}. Created by Ali Muridke (03091539086)`;
            openWhatsApp(phone, message);
            
            alert('Student added successfully! WhatsApp message ready to send.');
            document.getElementById('studentForm').reset();
            loadStudentsTable();
            updateStudentDropdown();
            updateDashboard();
        }

        function loadStudentsTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';

            const sortedStudents = [...students].sort((a, b) => a.grade - b.grade || a.name.localeCompare(b.name));
            
            sortedStudents.forEach(student => {
                // Calculate fee status for this month
                const currentMonth = new Date().toISOString().slice(0, 7);
                const studentFees = fees.filter(f => f.studentId === student.id && f.month === currentMonth);
                const totalPaid = studentFees.reduce((sum, fee) => sum + fee.amount, 0);
                const remaining = student.fee - totalPaid;
                
                let feeStatus = 'Pending';
                let statusClass = 'fee-pending';
                
                if (remaining <= 0) {
                    feeStatus = 'Paid';
                    statusClass = 'fee-paid';
                } else if (totalPaid > 0) {
                    feeStatus = `Partial (PKR ${remaining} due)`;
                    statusClass = 'fee-partial';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>Grade ${student.grade}</td>
                    <td>${student.phone}</td>
                    <td><span class="currency">${student.fee}</span></td>
                    <td><span class="fee-status ${statusClass}">${feeStatus}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteStudent(id) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteStudent';
            currentItemId = id;
            openPinModal();
        }

        // Fee Management functions
        function updateStudentDropdown() {
            if (!validateUserSession()) return;
            
            const dropdown = document.getElementById('feeStudent');
            dropdown.innerHTML = '<option value="">Select Student</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (Grade ${student.grade}) - PKR ${student.fee}/month`;
                option.setAttribute('data-fee', student.fee);
                dropdown.appendChild(option);
            });
            updateFeeInfo();
        }

        function updateFeeInfo() {
            if (!validateUserSession()) return;
            
            const studentId = document.getElementById('feeStudent').value;
            const month = document.getElementById('feeMonth').value;
            
            const monthlyFeeDisplay = document.getElementById('monthlyFeeDisplay');
            const remainingFeeDisplay = document.getElementById('remainingFeeDisplay');
            const feeAmountInput = document.getElementById('feeAmount');
            
            if (!studentId || !month) {
                monthlyFeeDisplay.textContent = '0';
                remainingFeeDisplay.textContent = '0';
                feeAmountInput.max = null;
                feeAmountInput.value = '';
                return;
            }
            
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Calculate already paid amount for this month
            const paidFees = fees.filter(f => f.studentId === studentId && f.month === month);
            const totalPaid = paidFees.reduce((sum, fee) => sum + fee.amount, 0);
            const remaining = student.fee - totalPaid;
            
            // Update displays
            monthlyFeeDisplay.textContent = student.fee;
            remainingFeeDisplay.textContent = remaining < 0 ? 0 : remaining;
            
            // Set max value for fee amount input to the remaining fee
            feeAmountInput.max = remaining < 0 ? 0 : remaining;
            
            // Set default value for amount input (suggest full remaining amount)
            if (remaining > 0) {
                 feeAmountInput.value = remaining;
            } else {
                 feeAmountInput.value = 0;
            }
        }

        function handleFeeCollection(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const studentId = document.getElementById('feeStudent').value;
            const month = document.getElementById('feeMonth').value;
            const amount = parseInt(document.getElementById('feeAmount').value);
            const datePaid = document.getElementById('feeDate').value;
            
            const student = students.find(s => s.id === studentId);
            if (!student) {
                alert('Please select a valid student');
                return;
            }
            
            // Recalculate remaining fee before processing
            const paidFees = fees.filter(f => f.studentId === studentId && f.month === month);
            const totalPaid = paidFees.reduce((sum, fee) => sum + fee.amount, 0);
            const remaining = student.fee - totalPaid;
            
            if (amount > remaining) {
                alert(`Cannot collect more than the remaining fee amount (PKR ${remaining < 0 ? 0 : remaining})`);
                return;
            }
            
            if (amount <= 0) {
                alert('Please enter a valid amount greater than zero');
                return;
            }
            
            const newFee = {
                id: generateId(),
                studentId,
                studentName: student.name,
                month,
                amount: amount,
                datePaid,
                collectedBy: currentUser.username || currentUser.email
            };
            
            fees.push(newFee);
            saveUserData();
            
            // WhatsApp message content
            const totalPaidNow = totalPaid + amount;
            const remainingAfterPayment = student.fee - totalPaidNow;
            const status = remainingAfterPayment <= 0 ? 'Fully Paid' : `Partially Paid (PKR ${remainingAfterPayment} due)`;
            
            const message = `Fee Receipt - ${student.name}\nMonth: ${month}\nAmount: PKR ${amount}\nStatus: ${status}\nDate: ${datePaid}\nThank you! - Created by Ali Muridke (03091539086)`;
            openWhatsApp(student.phone, message);
            
            alert('Fee collected successfully! WhatsApp receipt ready to send.');
            document.getElementById('feeForm').reset();
            document.getElementById('feeMonth').valueAsDate = new Date();
            document.getElementById('feeDate').value = new Date().toISOString().split('T')[0];
            loadFeesTable();
            loadStudentsTable();
            updateDashboard();
            updateFeeInfo();
        }

        function loadFeesTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#feesTable tbody');
            tbody.innerHTML = '';
            
            const sortedFees = [...fees].sort((a, b) => new Date(b.datePaid) - new Date(a.datePaid));
            
            sortedFees.forEach(fee => {
                const student = students.find(s => s.id === fee.studentId);
                if (!student) {
                    const rowDeleted = document.createElement('tr');
                    rowDeleted.innerHTML = `
                        <td>${fee.id}</td>
                        <td><span style="color:var(--danger); font-style:italic;">[DELETED] ${fee.studentName}</span></td>
                        <td>${fee.month}</td>
                        <td><span class="currency">${fee.amount}</span></td>
                        <td><span class="fee-status fee-pending">Archived</span></td>
                        <td>${fee.datePaid}</td>
                        <td class="action-buttons">
                            <button class="btn btn-danger btn-sm" onclick="deleteFee('${fee.id}')"><i class="fas fa-trash"></i> Delete</button>
                        </td>
                    `;
                    tbody.appendChild(rowDeleted);
                    return;
                }
                
                const totalMonthlyFee = student.fee;
                const paidFees = fees.filter(f => f.studentId === fee.studentId && f.month === fee.month);
                const totalPaidForMonth = paidFees.reduce((sum, f) => sum + f.amount, 0);
                const remaining = totalMonthlyFee - totalPaidForMonth;
                
                let status = 'Partial';
                let statusClass = 'fee-partial';
                
                if (remaining <= 0) {
                    status = 'Paid';
                    statusClass = 'fee-paid';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fee.id}</td>
                    <td>${fee.studentName}</td>
                    <td>${fee.month}</td>
                    <td><span class="currency">${fee.amount}</span></td>
                    <td><span class="fee-status ${statusClass}">${status}</span></td>
                    <td>${fee.datePaid}</td>
                    <td class="action-buttons">
                        <button class="btn btn-whatsapp btn-sm" onclick="resendReceipt('${fee.id}')"><i class="fab fa-whatsapp"></i> Resend</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFee('${fee.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update recent fees table on dashboard
            const recentFeesTbody = document.querySelector('#recentFeesTable tbody');
            recentFeesTbody.innerHTML = '';
            
            const recentFees = sortedFees.slice(0, 5);
            recentFees.forEach(fee => {
                const student = students.find(s => s.id === fee.studentId);
                if (!student) return;
                
                const paidFees = fees.filter(f => f.studentId === fee.studentId && f.month === fee.month);
                const totalPaid = paidFees.reduce((sum, f) => sum + f.amount, 0);
                const remaining = student.fee - totalPaid;

                let status = remaining <= 0 ? 'Paid' : 'Partial';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fee.studentName}</td>
                    <td><span class="currency">${fee.amount}</span></td>
                    <td><span class="fee-status ${status === 'Paid' ? 'fee-paid' : 'fee-partial'}">${status}</span></td>
                    <td>${fee.datePaid}</td>
                `;
                recentFeesTbody.appendChild(row);
            });
        }

        function resendReceipt(feeId) {
            if (!validateUserSession()) return;
            
            const fee = fees.find(f => f.id === feeId);
            const student = students.find(s => s.id === fee.studentId);
            
            if (!student) {
                alert("Student record not found. Cannot resend.");
                return;
            }

            const paidFees = fees.filter(f => f.studentId === fee.studentId && f.month === fee.month);
            const totalPaid = paidFees.reduce((sum, f) => sum + f.amount, 0);
            const remaining = student.fee - totalPaid;
            const status = remaining <= 0 ? 'Fully Paid' : `Partially Paid (PKR ${remaining} due)`;
            
            const message = `Fee Receipt - ${student.name}\nMonth: ${fee.month}\nAmount: PKR ${fee.amount}\nStatus: ${status}\nDate: ${fee.datePaid}\nThank you! - Created by Ali Muridke (03091539086)`;
            openWhatsApp(student.phone, message);
            
            alert('WhatsApp receipt ready to send!');
        }

        function deleteFee(id) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteFee';
            currentItemId = id;
            openPinModal();
        }

        // Attendance Management functions
        function toggleAttendance(studentId, isChecked) {
            if (!validateUserSession()) return;
            
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const date = document.getElementById('attendanceDate').value;
            const alertDiv = document.getElementById(`alert-status-${studentId}`);
            
            // Update the visual status
            if (isChecked) {
                alertDiv.innerHTML = '<span class="status-badge status-present">Present</span>';
            } else {
                alertDiv.innerHTML = '<span class="status-badge status-absent">Absent</span>';
                
                // Immediate WhatsApp Alert for Absent Student
                const message = `Attendance Alert: ${student.name} was marked absent on ${date}. Please contact the academy for more information. - Created by Ali Muridke (03091539086)`;
                openWhatsApp(student.phone, message);
            }
        }

        function loadAttendanceForm() {
            if (!validateUserSession()) return;
            
            const container = document.getElementById('attendanceList');
            container.innerHTML = '';
            
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">No students available. Please add students first.</p>';
                return;
            }
            
            const date = document.getElementById('attendanceDate').value;
            const existingRecord = attendance.find(a => a.date === date);

            // Group students by grade
            const studentsByGrade = students.reduce((acc, student) => {
                const grade = student.grade;
                if (!acc[grade]) acc[grade] = [];
                acc[grade].push(student);
                return acc;
            }, {});
            
            // Sort grades numerically
            const sortedGrades = Object.keys(studentsByGrade).sort((a, b) => parseInt(a) - parseInt(b));

            sortedGrades.forEach(grade => {
                const gradeContainer = document.createElement('div');
                gradeContainer.style.marginBottom = '20px';
                gradeContainer.innerHTML = `<h4 style="color: var(--secondary); border-bottom: 1px dashed var(--border); padding-bottom: 5px; margin-bottom: 15px;">Grade ${grade}</h4>`;
                
                // Sort students alphabetically within the grade
                studentsByGrade[grade].sort((a, b) => a.name.localeCompare(b.name));

                studentsByGrade[grade].forEach(student => {
                    // Determine initial status: checked if present in existing record, or default to present (true)
                    const isPresent = existingRecord ? existingRecord.present.includes(student.id) : true;
                    
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.marginBottom = '10px';
                    div.style.padding = '10px';
                    div.style.border = '1px solid var(--border)';
                    div.style.borderRadius = '6px';
                    div.style.backgroundColor = 'var(--surface)'; 
                    div.setAttribute('data-student-id', student.id);
                    
                    const statusText = isPresent ? 'Present' : 'Absent';
                    const statusClass = isPresent ? 'status-present' : 'status-absent';

                    div.innerHTML = `
                        <input type="checkbox" id="attendance-${student.id}" class="attendance-checkbox" ${isPresent ? 'checked' : ''} style="display: none;">
                        <label style="margin: 0; flex-grow: 1; color: var(--text-primary); font-weight: 500;">${student.name}</label>
                        <div id="alert-status-${student.id}" style="margin-right: 15px;">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="action-buttons" style="gap: 5px;">
                            <button type="button" class="btn btn-sm btn-success attendance-toggle-btn" data-id="${student.id}" data-action="present" title="Mark Present (✅)" style="padding: 8px; width: 35px; height: 35px;"><i class="fas fa-check"></i></button>
                            <button type="button" class="btn btn-sm btn-danger attendance-toggle-btn" data-id="${student.id}" data-action="absent" title="Mark Absent (❌)" style="padding: 8px; width: 35px; height: 35px;"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                    
                    gradeContainer.appendChild(div);
                });
                
                container.appendChild(gradeContainer);
            });
            
            // Attach event listeners for the new toggle buttons
            document.querySelectorAll('.attendance-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    const action = this.getAttribute('data-action');
                    const checkbox = document.getElementById(`attendance-${studentId}`);
                    
                    if (action === 'present') {
                        if (!checkbox.checked) {
                            checkbox.checked = true;
                            toggleAttendance(studentId, true); 
                        }
                    } else if (action === 'absent') {
                        if (checkbox.checked) {
                            checkbox.checked = false;
                            toggleAttendance(studentId, false); 
                        }
                    }
                });
            });
        }

        function handleAttendance(e) {
            e.preventDefault();
            if (!validateUserSession()) return;
            
            const date = document.getElementById('attendanceDate').value;
            
            // Remove existing attendance before adding new one
            attendance = attendance.filter(a => a.date !== date);
            
            const presentStudents = [];
            const absentStudents = [];
            
            students.forEach(student => {
                // Read state from the hidden checkbox
                const checkbox = document.getElementById(`attendance-${student.id}`);
                if (checkbox && checkbox.checked) {
                    presentStudents.push(student.id);
                } else if (checkbox) {
                    absentStudents.push(student.id);
                }
            });
            
            if (students.length === 0) {
                 alert('No students to mark attendance for.');
                 return;
            }

            const newAttendance = {
                id: generateId(),
                date,
                present: presentStudents,
                absent: absentStudents,
                markedBy: currentUser.username || currentUser.email
            };
            
            attendance.push(newAttendance);
            saveUserData();
            
            alert('Attendance saved successfully! Absent student alerts were sent via WhatsApp upon marking.');
            
            // Reload form to reflect newly saved data/reset the state
            loadAttendanceForm(); 
            loadAttendanceTable();
            updateDashboard();
        }

        function resendAbsentAlerts(attendanceId) {
            if (!validateUserSession()) return;
            
            const record = attendance.find(a => a.id === attendanceId);
            
            if (!record) {
                alert("Attendance record not found.");
                return;
            }
            
            record.absent.forEach(studentId => {
                const student = students.find(s => s.id === studentId);
                if (student) {
                    const message = `Attendance Alert: ${student.name} was absent on ${record.date}. Please contact the academy for more info thanks information. - Created by Ali Muridke (03091539086)`;
                    openWhatsApp(student.phone, message);
                }
            });
            
            alert('WhatsApp alerts ready to send for absent students!');
        }

        function deleteAttendance(id) {
            if (!validateUserSession()) return;
            
            currentAction = 'deleteAttendance';
            currentItemId = id;
            openPinModal();
        }
        
        function loadAttendanceTable() {
            if (!validateUserSession()) return;
            
            const tbody = document.querySelector('#attendanceTable tbody');
            tbody.innerHTML = '';
            
            const sortedAttendance = [...attendance].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedAttendance.forEach(record => {
                const totalStudentsOnDate = students.length > 0 ? students.length : (record.present.length + record.absent.length);
                const percentage = totalStudentsOnDate > 0 ? Math.round((record.present.length / totalStudentsOnDate) * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td><span class="status-badge status-present">${record.present.length}</span></td>
                    <td><span class="status-badge status-absent">${record.absent.length}</span></td>
                    <td>${percentage}%</td>
                    <td class="action-buttons">
                        <button class="btn btn-whatsapp btn-sm" onclick="resendAbsentAlerts('${record.id}')"><i class="fab fa-whatsapp"></i> Resend Alerts</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAttendance('${record.id}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update recent attendance table on dashboard
            const recentAttendanceTbody = document.querySelector('#recentAttendanceTable tbody');
            recentAttendanceTbody.innerHTML = '';
            
            const recentAttendance = sortedAttendance.slice(0, 5);
            recentAttendance.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.present.length}</td>
                    <td>${record.absent.length}</td>
                `;
                recentAttendanceTbody.appendChild(row);
            });
        }

        // WhatsApp Integration
        function openWhatsApp(phone, message) {
            let cleanPhone = phone.replace(/\D/g, '');
            if (cleanPhone.startsWith('03')) {
                cleanPhone = '92' + cleanPhone.substring(1);
            }
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // PIN Protected Actions
        function openPinModal() {
            if (!validateUserSession()) return;
            
            document.getElementById('pinModal').style.display = 'flex';
            document.getElementById('pinInput').value = '';
            document.getElementById('pinInput').focus();
        }

        function closePinModal() {
            document.getElementById('pinModal').style.display = 'none';
            currentAction = null;
            currentItemId = null;
        }

        function verifyPin() {
            if (!validateUserSession()) return;
            
            const pin = document.getElementById('pinInput').value;
            
            if (!currentUser || !currentUser.pin) {
                alert('No admin PIN found. Login again.');
                closePinModal();
                return;
            }

            if (pin === currentUser.pin) {
                executeProtectedAction();
                closePinModal();
            } else {
                alert('Incorrect PIN. Please try again.');
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').focus();
            }
        }

        function executeProtectedAction() {
            if (!currentItemId || !validateUserSession()) return;

            switch(currentAction) {
                case 'deleteStudent':
                    if (confirm('Are you sure you want to PERMANENTLY delete this student? Fee and attendance history will remain but be marked as archived.')) {
                        students = students.filter(s => s.id !== currentItemId);
                        saveUserData();
                        loadStudentsTable();
                        updateStudentDropdown();
                        updateDashboard();
                        alert('Student deleted successfully');
                    }
                    break;
                case 'deleteFee':
                    if (confirm('Are you sure you want to PERMANENTLY delete this fee receipt?')) {
                        fees = fees.filter(f => f.id !== currentItemId);
                        saveUserData();
                        loadFeesTable();
                        loadStudentsTable();
                        updateDashboard();
                        alert('Fee record deleted successfully');
                    }
                    break;
                case 'deleteAttendance':
                    if (confirm('Are you sure you want to PERMANENTLY delete this attendance record?')) {
                        attendance = attendance.filter(a => a.id !== currentItemId);
                        saveUserData();
                        loadAttendanceTable();
                        updateDashboard();
                        alert('Attendance record deleted successfully');
                    }
                    break;
                default:
                    alert('Action not defined for PIN protection.');
            }
        }

        // Dashboard functions
        function updateDashboard() {
            if (!validateUserSession()) return;
            
            document.getElementById('totalStudents').textContent = students.length;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthlyFees = fees.filter(f => f.month === currentMonth)
                                   .reduce((sum, fee) => sum + fee.amount, 0);
            document.getElementById('feesCollected').textContent = monthlyFees;
            
            const today = new Date().toISOString().split('T')[0];
            const todayRecord = attendance.find(a => a.date === today);
            
            if (todayRecord) {
                const totalRegisteredStudents = students.length; 
                let percentage = 0;
                if (totalRegisteredStudents > 0) {
                     percentage = Math.round((todayRecord.present.length / totalRegisteredStudents) * 100);
                }
                document.getElementById('todayAttendance').textContent = `${percentage}%`;
            } else {
                document.getElementById('todayAttendance').textContent = 'Not taken';
            }
            
            let pendingCount = 0;
            students.forEach(student => {
                const studentFees = fees.filter(f => f.studentId === student.id && f.month === currentMonth);
                const totalPaid = studentFees.reduce((sum, fee) => sum + fee.amount, 0);
                if (totalPaid < student.fee) {
                    pendingCount++;
                }
            });
            document.getElementById('pendingFees').textContent = pendingCount;
        }

        // Calculator functions
        function appendToCalc(value) {
            calcExpression += value;
            document.getElementById('calcDisplay').value = calcExpression;
        }

        function clearCalc() {
            calcExpression = '';
            document.getElementById('calcDisplay').value = '';
        }

        function deleteLast() {
            calcExpression = calcExpression.slice(0, -1);
            document.getElementById('calcDisplay').value = calcExpression;
        }

        function calculateResult() {
            try {
                const safeExpression = calcExpression.replace(/[^-()\d/*+.×]/g, ''); 
                const expressionToEval = safeExpression.replace(/×/g, '*'); 
                const result = eval(expressionToEval); 
                
                calcExpression = result.toString();
                document.getElementById('calcDisplay').value = calcExpression;
            } catch (error) {
                alert('Invalid calculation');
                clearCalc();
            }
        }

        // Utility functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9).toUpperCase();
        }
    </script>
</body>
</html>